name: Test SSH Connection

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ test/action ] # å¯é…ç½®ä¸ºåœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨æµ‹è¯•

jobs:
  ssh-connection-test:
    name: Test SSH to Aliyun
    runs-on: ubuntu-latest
    
    steps:
      - name: Check SSH connection
        uses: appleboy/ssh-action@v1.0.0  # ä½¿ç”¨æœ€æ–°çš„ v1 ç‰ˆæœ¬
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ secrets.ALIYUN_SSH_PORT || 22 }}
          script: |
            echo "========================================"
            echo "âœ… SSHè¿æ¥æˆåŠŸï¼"
            echo "========================================"
            echo "æœåŠ¡å™¨ä¿¡æ¯:"
            echo "ä¸»æœºå: $(hostname)"
            echo "IPåœ°å€: $(hostname -I)"
            echo "æ“ä½œç³»ç»Ÿ: $(cat /etc/os-release | grep PRETTY_NAME | cut -d\" -f2)"
            echo "å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
            echo "å½“å‰ç”¨æˆ·: $(whoami)"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo ""
            echo "========================================"
            echo "ğŸ”„ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥:"
            echo "è¿è¡Œæ—¶é—´: $(uptime -p)"
            echo "å†…å­˜ä½¿ç”¨: $(free -m | awk 'NR==2{printf "%.2f%%", $3*100/$2}')"
            echo "ç£ç›˜ä½¿ç”¨: $(df -h / | awk 'NR==2{print $5}')"
            echo ""
            echo "========================================"
            echo "ğŸ” å…³é”®æœåŠ¡çŠ¶æ€:"
            systemctl status nginx --no-pager || true
            echo ""
            systemctl status ssh --no-pager || true
            echo ""
            echo "========================================"
            echo "ğŸ“ é¡¹ç›®ç›®å½•æ£€æŸ¥:"
            echo "ç½‘ç«™ç›®å½•: /www/wwwroot/${{ secrets.ALIYUN_DOMAIN || 'your-domain' }}"
            ls -la /www/wwwroot/${{ secrets.ALIYUN_DOMAIN || 'your-domain' }} || true
            echo ""
            echo "========================================"
            echo "ğŸŒ ç½‘ç»œè¿é€šæ€§æµ‹è¯•:"
            ping -c 2 github.com
            echo ""
            echo "âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼"
          timeout: 30s  # è¶…æ—¶è®¾ç½®